#!/bin/sh

# Global variables
DMENU="rofi -dmenu -p Unmount-utility"

# Populate list of unmountable devices
deviceNames=$(findmnt -Do TARGET | grep "/media" | tr " " "_" | sed \
"s/\/media\///" | tr "\n" " ")
deviceSources=$(findmnt -Do SOURCE | grep "sd[b-z]" | tr "\n" " " )
deviceCount=$(echo $deviceSources | wc -w)

# Are there any devices?
if [[ $deviceCount == 0 ]]; then
    notify-send "No devices found"
    exit 1
fi

# Display list of devices that can be unmounted
touch ~/list.txt
for ((device=1; device<=${deviceCount}; device+=1))
do
    curName=$(echo $deviceNames | cut -d " " -f${device})
    curSource=$(echo $deviceSources | cut -d " " -f${device})
    printf "%4s)   %-25s%-13s\n" ${device} ${curName} ${curSource} >> ~/list.txt
done

printf "%4s)   Exit\n" "x" >> ~/list.txt

# Get input from user
input=$(cat ~/list.txt | $DMENU $*)
echo $input

# Input validation
if echo $input | grep "Exit"
then
    rm ~/list.txt
    exit 0
else
    tounmount=$(echo $input | cut -d " " -f3)
    name=$(echo $input | cut -d " " -f2)
fi

if !(udevil umount ${tounmount}); then
    notify-send "Input did not match any device"
fi
rm ~/list.txt
exit 0
