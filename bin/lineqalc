#!/bin/bash

# help
if [ $1 == "-h" ]; then
    echo 1>&2 "Usage:
    lineqalc inputfile expression [separator]
    
    inputfile: tablefile to be read
    expression: mathematical expression as needed by qalc, you can use column
      letters like A to reference columns of the tablefile
    separator: separatorstring of the tablefile, comma is default

    e.g.: lineqalc test.csv \"cosh(A)-sinh(B)\""
    exit 0
fi

# necessary input
if [ $# -lt 2 ]; then
    echo "please enter an input file and an expression, enter '-h' for help"
    exit 1
# separator provided? else default
elif [ $# == 2 ]; then
    sep=","
elif [ $# == 3 ]; then
    sep=$3
# too much
else
    echo "Too many arguments, enter '-h' for help"
    exit 1
fi

# columns
cols=$(head -n 1 $1 | awk -F${sep} '{ print NF }')

# line number
l=1
# list of column variables
alph="A B C D E F G H I J K L M N O P Q R S T U V W X Y Z"

# loop over line numbers
IFS=$'\n'
for i in $(cat $1)
do
    # math expression
    exp=$2
    # loop over columns
    for (( j = 1; j <= $cols; j++ )); do
        # current column variable
        curalph=$(echo $alph | cut -d " " -f$j)
        # current column value
        sub=$(printf "awk -F%s '{print $%s}' %s\n" $sep $j $1 | bash | sed -n "${l}p")
        # substitute variable with value
        exp=$(echo $exp | sed "s/$curalph/$sub/g")
    done
    # calculate the result of the column
    res=$(echo $exp | qalc -t | sed -n "3p" | sed "s/ *//g")
    res=$(LC_ALL=C printf "%0.2f\n" $res)
    # append it to file
    echo "${i}${sep}${res}" >> tmp.out

    (( l++ ))
done

# move the temporary file to the input
mv tmp.out $1

exit 0
